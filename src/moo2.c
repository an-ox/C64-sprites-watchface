#include <pebble.h>
#include <pebble.h>

// This is just a fun watch face that displays the time, and a
// sprite animation ripped from some of Llamasoft's Commodore 64 games.
// It's set up to change the animation on the hour.


#define CORNER_RADIUS 1
#define CHROME 0

#define NUM_SECOND_PIPS 60
#define PIPS_RADIUS 70

#define XREZ 144
#define YREZ 168 
#define CENTREX 72
#define CENTREY 84

static Window *window;
static Layer *canvas;

// using an apptimer allows us to easily change the update rate

static AppTimer *timer;
static uint32_t delta = 500;

// let's declare a struct for pixel bitmaps in general
// as I intend to be using them quite a bit.

struct pixMap
{
// information about the bitmap format
  uint8_t width;
  uint8_t height;
  uint8_t index;
  void *raw;        // the raw bitmap data
// information about the position and scale
  uint16_t dotPitchX;	// Step per glyph X pixel
  uint16_t dotWidth;	// Actual size of X pixel
  uint16_t dotPitchY;	// Step per glyph Y pixel
  uint16_t dotHeight;   // Size of y pixel
  uint16_t x;
  uint16_t y;
  int col;		// Colour
  const int *pal;	// Palette, NULL if 1 bpp
  const int *plpal;     // Per line palette, usually NULL 
// stuff that will be used to animate a pixmap
  uint8_t minFrame;
  uint8_t maxFrame;
  int8_t frameStep;
  uint8_t animFlags;
};

// an array of 4 pixMaps to use for the main time digits

struct pixMap *timeDigits[4];

// a pixMap to animate a sprite in

struct pixMap *c64sprite;

// a pixMap for the "watchmaker's mark"

struct pixMap *jm;

// this is the raw data for 10 8x8 mono bitmap digits

const uint8_t amcdigits[]=
{
// new 8x8 font simple digits

  0xff,0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xff,  // 0
  0xf8,0x18,0x18,0x18,0x18,0x18,0x18,0xff,  // 1
  0xff,0x03,0x03,0xff,0xc0,0xc0,0xc0,0xff,  // 2
  0xff,0x03,0x03,0x3f,0x03,0x03,0x03,0xff,  // 3
  0xc3,0xc3,0xc3,0xff,0x03,0x03,0x03,0x03,  // 4
  0xff,0xc0,0xc0,0xff,0x03,0x03,0x03,0xff,  // 5
  0xff,0xc0,0xc0,0xff,0xc3,0xc3,0xc3,0xff,  // 6
  0xff,0x03,0x03,0x03,0x03,0x03,0x03,0x03,  // 7
  0xff,0xc3,0xc3,0xff,0xc3,0xc3,0xc3,0xff,  // 8
  0xff,0xc3,0xc3,0xff,0x03,0x03,0x03,0xff,  // 9

};

// here are 2 palettes to colour the digits if it's am or pm

const int digitpal_am[8]={0xff982c,0xffc51d,0xffd84c,0xfff486,0xfff486,0xffd84c,0xffc51d,0xff982c};
const int digitpal_pm[8]={0x4c98ff,0x2dc5ff,0x8cd8ff,0xc6f4ff,0xc6f4ff,0x8cd8ff,0x2dc5ff,0x4c98ff};

// here is some ripped sprite data

const uint8_t sprites[]=
{

// cippy side view fr. 0-3

  0x01,0xff,0x00,0x1f,0x87,0xe0,0x70,0x00,
  0x70,0x00,0x00,0x78,0x00,0x01,0xcc,0x00,
  0x0f,0xfe,0x00,0x3f,0x9f,0x00,0x7f,0xc6,
  0x00,0x7e,0xe0,0x00,0xfe,0x70,0x00,0xfe,
  0x70,0x00,0xfe,0x30,0x00,0xfe,0x00,0x01,
  0xc7,0x00,0x01,0xc7,0x00,0x03,0x83,0x80,
  0x03,0x83,0x80,0x07,0x03,0xc0,0x07,0x01,
  0xc0,0x07,0x81,0xf0,0x03,0xc0,0xf8,

  0x01,0xff,0x00,0x1f,0x87,0xe0,0x70,0x00,
  0x70,0x00,0x00,0x78,0x00,0x01,0xcc,0x00,
  0x0f,0xfe,0x00,0x3f,0x9f,0x00,0x7f,0xc6,
  0x00,0x7e,0xe0,0x00,0xfe,0xe0,0x00,0xfe,
  0xe0,0x00,0xfe,0xc0,0x00,0xfe,0x00,0x01,
  0xee,0x00,0x01,0xe7,0x00,0x03,0xe7,0x00,
  0x0f,0x87,0x00,0x0e,0x07,0x00,0x0f,0x07,
  0x00,0x06,0x07,0xc0,0x00,0x07,0xc0,

  0x01,0xff,0x00,0x1f,0x87,0xe0,0x70,0x00,
  0x70,0x00,0x00,0x78,0x00,0x01,0xcc,0x00,
  0x0f,0xfe,0x00,0x3f,0x9f,0x00,0x7f,0xc6,
  0x00,0x7e,0xc0,0x00,0xfe,0xe0,0x00,0xfe,
  0xe0,0x00,0xfe,0x60,0x00,0xfe,0x00,0x00,
  0xfe,0x00,0x00,0x7f,0x00,0x00,0x1f,0x80,
  0x00,0xff,0x00,0x01,0xfc,0x00,0x01,0xdc,
  0x00,0x00,0x1e,0x00,0x00,0x1f,0x00,

  0x1f,0xf0,0x00,0x78,0x3f,0x00,0x00,0x03,
  0xe0,0x00,0x00,0x70,0x00,0x01,0xfc,0x00,
  0x0f,0xcc,0x00,0x3f,0xfe,0x00,0x7f,0xdf,
  0x00,0x7e,0xc6,0x00,0xfe,0xe0,0x00,0xfe,
  0x70,0x00,0xfe,0x30,0x00,0xfe,0x00,0x00,
  0xfe,0x00,0x00,0x7f,0x00,0x00,0x7f,0x80,
  0x00,0x77,0xc0,0x00,0xf1,0xf8,0x00,0xe0,
  0xf0,0x00,0xe0,0x60,0x00,0xf0,0x00,

// cippy front view landing after jump fr. 4-7

  0x07,0x81,0xe0,0x0c,0xff,0x30,0x10,0x5a,
  0x08,0x00,0x5a,0x00,0x00,0x3c,0x00,0x00,
  0x18,0x00,0x00,0x66,0x00,0x01,0xff,0x80,
  0x03,0xff,0xc0,0x07,0xff,0xe0,0x0e,0x7f,
  0x70,0x1c,0x7f,0x30,0x18,0x7f,0x18,0x00,
  0x7f,0x00,0x00,0x67,0x00,0x00,0xe3,0x00,
  0x00,0xc3,0x00,0x00,0xc3,0x00,0x00,0xc3,
  0x00,0x01,0xc3,0x80,0x03,0x81,0xc0,

  0x07,0x81,0xf0,0x0d,0xe7,0x98,0x10,0x7e,
  0x04,0x00,0x5a,0x00,0x00,0x5a,0x00,0x00,
  0x3c,0x00,0x00,0x5a,0x00,0x01,0xe7,0x80,
  0x07,0xff,0xc0,0x06,0xff,0x60,0x0e,0x7f,
  0x70,0x0c,0x7f,0x30,0x00,0x7f,0x00,0x00,
  0x7f,0x00,0x00,0x67,0x00,0x00,0x63,0x00,
  0x00,0xe3,0x00,0x00,0xe3,0x80,0x00,0xc1,
  0x80,0x00,0xc1,0x80,0x03,0xc1,0xe0,

  0x00,0x00,0x00,0x07,0x00,0xe0,0x09,0xc3,
  0x90,0x00,0xe7,0x00,0x00,0xfe,0x00,0x00,
  0x5a,0x00,0x00,0x5a,0x00,0x00,0x3c,0x00,
  0x00,0x3c,0x00,0x03,0xdb,0xe0,0x1f,0xe7,
  0xf0,0x30,0x7f,0x3c,0x00,0x7f,0x06,0x00,
  0x7f,0x00,0x00,0xff,0x00,0x01,0xc3,0x80,
  0x03,0x81,0xc0,0x03,0x81,0xc0,0x01,0xc1,
  0x80,0x00,0xc1,0x80,0x03,0xc1,0xe0,

  0x04,0x00,0x20,0x03,0x00,0xc0,0x01,0x81,
  0x80,0x00,0xc3,0x00,0x00,0xc3,0x00,0x00,
  0x66,0x00,0x00,0x7e,0x00,0x00,0x5a,0x00,
  0x3c,0x5a,0x1e,0x0f,0x3c,0x78,0x07,0xbd,
  0xf0,0x01,0xdb,0x80,0x00,0x67,0x00,0x00,
  0x7f,0x00,0x00,0xff,0x00,0x00,0xff,0x80,
  0x03,0xe7,0xc0,0x07,0x01,0xe0,0x07,0xc0,
  0xf0,0x00,0xc1,0xc0,0x01,0x80,0xe0,

// ROTMC walking camel animation fr. 8-15

  0x00,0x00,0x10,0x00,0x00,0x1c,0x00,0x00,	// 1
  0x16,0x07,0x80,0x1c,0x0f,0xe0,0x38,0x1f,
  0xf0,0x38,0x3f,0xf8,0x70,0x3f,0xfc,0xf0,
  0x7f,0xff,0xe0,0xfb,0xff,0xc0,0xbd,0xff,
  0x80,0xbc,0x3f,0x00,0x3a,0x0e,0x00,0x76,
  0x07,0x00,0x73,0x0b,0x00,0x61,0x99,0x80,
  0x61,0x98,0xc0,0x63,0x30,0xc0,0x63,0x19,
  0x80,0x63,0x0d,0x80,0x73,0x8d,0xc0,

  0x00,0x00,0x10,0x00,0x00,0x1c,0x00,0x00,	// 2
  0x16,0x07,0x80,0x3c,0x0f,0xe0,0x38,0x1f,
  0xf0,0x70,0x3f,0xf8,0x70,0x3f,0xfc,0xe0,
  0x7f,0xff,0xe0,0xfb,0xff,0xc0,0xb9,0xff,
  0x80,0xbc,0x3f,0x00,0x78,0x0e,0x00,0xe6,
  0x06,0x00,0xe6,0x1b,0x00,0xc3,0x33,0x00,
  0xc3,0x31,0x80,0xc6,0x31,0x80,0xc6,0x33,
  0x00,0x66,0x1b,0x00,0x27,0x03,0x80,

  0x00,0x00,0x10,0x00,0x00,0x1c,0x00,0x00,	// 3
  0x16,0x07,0x80,0x3c,0x0f,0xe0,0x38,0x1f,
  0xf0,0x70,0x3f,0xf8,0x70,0x3f,0xfc,0xe0,
  0x7f,0xff,0xe0,0xfb,0xff,0xc0,0xb9,0xff,
  0x80,0x3c,0x3f,0x00,0xf8,0x0e,0x00,0xe6,
  0x06,0x00,0xc6,0x16,0x00,0xc6,0x1b,0x00,
  0x66,0x1b,0x00,0x66,0x13,0x00,0x76,0x16,
  0x00,0x34,0x06,0x00,0x0c,0x07,0x00,

  0x00,0x00,0x10,0x00,0x00,0x1c,0x00,0x00,	// 4
  0x16,0x07,0x80,0x1c,0x0f,0xe0,0x1c,0x1f,
  0xf0,0x38,0x3f,0xf8,0x78,0x3f,0xfc,0xf0,
  0x7f,0xff,0xe0,0xfb,0xff,0xc0,0xb9,0xff,
  0x80,0x3c,0x3f,0x00,0x78,0x0e,0x00,0x78,
  0x06,0x80,0x64,0x06,0x80,0x6c,0x06,0x00,
  0x34,0x07,0x00,0x18,0x06,0x00,0x1e,0x16,
  0x00,0x00,0x06,0x00,0x18,0x07,0x00,

  0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,	// 5
  0x1c,0x07,0x80,0x16,0x0f,0xe0,0x1c,0x1f,
  0xf0,0x3c,0x3f,0xf8,0x78,0x3f,0xfc,0xf0,
  0x7f,0xff,0xe0,0xfb,0xff,0xc0,0xbd,0xff,
  0x80,0xbe,0x3f,0x00,0x7c,0x0e,0x00,0x30,
  0x06,0x80,0x1c,0x06,0xc0,0x0c,0x06,0xc0,
  0x2c,0x16,0x80,0x36,0x16,0x00,0x33,0x06,
  0x00,0x30,0x06,0x00,0x38,0x07,0x00,

  0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,	// 6
  0x1c,0x07,0x80,0x16,0x0f,0xe0,0x1c,0x1f,
  0xf0,0x1c,0x3f,0xf8,0x38,0x3f,0xfc,0xf8,
  0x7f,0xff,0xf0,0xfb,0xff,0xe0,0xbd,0xff,
  0x80,0xbe,0x3f,0x00,0x3c,0x0e,0x00,0x38,
  0x06,0x80,0x1c,0x06,0x80,0x0e,0x0c,0xc0,
  0x23,0x0e,0xc0,0x61,0x8d,0x80,0x61,0xcd,
  0x00,0x60,0x06,0x00,0x78,0x07,0x00,

  0x00,0x00,0x10,0x00,0x00,0x1c,0x00,0x00,	// 7
  0x16,0x07,0x80,0x1c,0x0f,0xe0,0x3c,0x1f,
  0xf0,0x3c,0x3f,0xf8,0x78,0x3f,0xfc,0xf0,
  0x7f,0xff,0xe0,0xfb,0xff,0xc0,0xbd,0xff,
  0x80,0xbe,0x3f,0x00,0x3e,0x0e,0x00,0x1e,
  0x06,0x80,0x1c,0x06,0x80,0x26,0x0c,0xc0,
  0x73,0x0e,0xc0,0x63,0x0c,0xc0,0x61,0x8c,
  0x60,0x61,0x8c,0x60,0x70,0xee,0x30,

  0x00,0x00,0x10,0x00,0x00,0x1c,0x00,0x00,	// 8
  0x16,0x07,0x80,0x3c,0x0f,0xe0,0x38,0x1f,
  0xf0,0x70,0x3f,0xf8,0x70,0x3f,0xfc,0xe0,
  0x7f,0xff,0xe0,0xfb,0xff,0xc0,0xbd,0xff,
  0x80,0xbe,0x3f,0x00,0x3e,0x0e,0x00,0x1e,
  0x06,0x80,0x5c,0x06,0x80,0x66,0x0c,0x80,
  0x66,0x1c,0xc0,0xc3,0x18,0xc0,0xc3,0x18,
  0xc0,0xc3,0x0d,0x80,0xe1,0x8e,0xc0,

// The skiing kangaroo fr. 16-19

  0x00,0x38,0x00,0x00,0x70,0x00,0x01,0xb0,
  0x00,0x01,0xf0,0x00,0x00,0x70,0x00,0x02,
  0x78,0x00,0x0e,0x3c,0x00,0x0f,0xfe,0x00,
  0x18,0xff,0x00,0xb0,0x1f,0x83,0x60,0x1f,
  0xfe,0x60,0x0f,0xf8,0x10,0x0f,0x80,0x00,
  0x07,0x00,0x00,0x0f,0x00,0x00,0x0e,0x00,
  0xc0,0x1c,0x00,0x7f,0xff,0xff,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,

  0x00,0x70,0x00,0x00,0xe0,0x00,0x03,0x60,
  0x00,0x03,0xe0,0x00,0x00,0xe0,0x00,0x00,
  0xf0,0x00,0x00,0x78,0x00,0x0f,0xfe,0x00,
  0x07,0xff,0x03,0x06,0x1f,0x8e,0x06,0x1f,
  0xfc,0x06,0x0f,0xe0,0x06,0x0f,0x80,0x06,
  0x07,0x00,0x1f,0x8f,0x00,0x06,0x0e,0x00,
  0xc0,0x1c,0x00,0x7f,0xff,0xff,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,

  0x00,0xe0,0x00,0x01,0xc0,0x00,0x06,0xc0,
  0x00,0x07,0xc0,0x00,0x01,0xc0,0x00,0x01,
  0xe0,0x00,0x00,0x78,0x00,0x03,0xfe,0x06,
  0x1f,0xff,0x0c,0x1c,0x3f,0x1c,0x06,0x3f,
  0xf8,0x03,0x1f,0xc0,0x01,0x8f,0x00,0x00,
  0xd7,0x00,0x00,0x6f,0x00,0x00,0x7e,0x00,
  0xc0,0x9c,0x00,0x7f,0xff,0xff,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,

  0x00,0xe0,0x00,0x03,0x80,0x00,0x0d,0x80,
  0x00,0x0f,0x80,0x00,0x03,0x80,0x00,0x03,
  0xc0,0x00,0x00,0xf0,0x00,0x01,0xfe,0x00,
  0x03,0xff,0x03,0x06,0x7f,0x9e,0x1f,0xff,
  0xf8,0xcc,0x7f,0xc0,0xc0,0x0f,0x00,0x60,
  0x07,0x00,0x3c,0x07,0x00,0x07,0x8f,0x00,
  0x00,0xfc,0x00,0x00,0x1e,0x00,0x00,0x03,
  0xc0,0x00,0x00,0x78,0x00,0x00,0x0e,

  // flying bactrian camel out of Sheep In Space fr. 20-23

  0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x00,
  0x1f,0x00,0x00,0x17,0x00,0x00,0x1c,0x00,
  0x00,0x1c,0x00,0x63,0x1c,0x00,0xf7,0xb8,
  0x0f,0xff,0xb8,0x39,0xff,0xf0,0xc1,0xff,
  0xe0,0x01,0xff,0x90,0x03,0xff,0xcb,0x1b,
  0x9c,0xe6,0x77,0x00,0x70,0x0e,0x00,0x3b,
  0x7c,0x00,0x1e,0x70,0x00,0x0c,0x60,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,

  0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x00,
  0x1f,0x00,0x00,0x17,0x00,0x00,0x1c,0x00,
  0x00,0x1c,0x00,0x63,0x1c,0x00,0xf7,0xb8,
  0x3f,0xff,0xb8,0xe1,0xff,0xf0,0x01,0xff,
  0xe0,0x01,0xff,0x90,0x03,0xff,0xcb,0x1b,
  0x9c,0xe6,0x77,0x00,0x70,0x0e,0x00,0x3b,
  0x7c,0x00,0x1e,0x70,0x00,0x0c,0x60,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,

  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x18,0x00,0x00,0x1f,0x00,0x00,0x17,0x00,
  0x00,0x1c,0xe0,0x63,0x1c,0x30,0xf7,0x9c,
  0x1f,0xff,0xb8,0x01,0xff,0xf8,0x01,0xff,
  0xe0,0x01,0xff,0x90,0x03,0xff,0xcb,0x1b,
  0x9c,0xe6,0x77,0x00,0x70,0x0e,0x00,0x3b,
  0x7c,0x00,0x1e,0x70,0x00,0x0c,0x60,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,

  0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x00,
  0x1f,0x00,0x00,0x1f,0x00,0x00,0x1c,0x00,
  0x00,0x1c,0x00,0x63,0x1c,0xe0,0xf7,0xb8,
  0xbf,0xff,0xb8,0x01,0xff,0xf0,0x01,0xff,
  0xe0,0x01,0xff,0x90,0x03,0xff,0xcb,0x1b,
  0x9c,0xe6,0x77,0x00,0x70,0x0e,0x00,0x3b,
  0x7c,0x00,0x1e,0x70,0x00,0x0c,0x60,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,

// Gordon Bennett (multicolour) 24-28

  0x00,0xa8,0x00,0x00,0xa8,0x00,0x02,0xaa,
  0x00,0x00,0x5c,0x00,0x00,0x54,0x00,0x00,
  0x54,0x00,0x00,0x50,0x00,0x00,0xfc,0x00,
  0x00,0xab,0x00,0x00,0xff,0xf5,0x00,0xaa,
  0xf4,0x00,0xff,0x00,0x00,0xaa,0x00,0x00,
  0xf3,0xc0,0x00,0xf3,0xc0,0x03,0xc3,0xc0,
  0x03,0xc0,0xf0,0x03,0xc0,0xf0,0x0f,0x00,
  0xf0,0x0f,0x00,0x3c,0x0a,0x80,0x2a,

  0x00,0xa8,0x00,0x00,0xa8,0x00,0x02,0xaa,
  0x00,0x00,0x5c,0x00,0x00,0x54,0x00,0x00,
  0x54,0x00,0x00,0x50,0x00,0x00,0xfc,0x00,
  0x00,0xab,0x00,0x00,0xff,0xf5,0x00,0xaa,
  0xf4,0x00,0xff,0x00,0x00,0xaa,0x00,0x00,
  0xf3,0x00,0x03,0xf3,0x00,0x03,0xc3,0xc0,
  0x03,0x03,0xc0,0x0f,0x03,0xc0,0x0f,0x00,
  0xf0,0x3c,0x00,0xf0,0x2a,0x00,0xa8,

  0x00,0xa8,0x00,0x00,0xa8,0x00,0x02,0xaa,
  0x00,0x00,0x5c,0x00,0x00,0x54,0x00,0x00,
  0x54,0x00,0x00,0x50,0x00,0x00,0xfc,0x00,
  0x00,0xab,0x00,0x00,0xff,0xf5,0x00,0xaa,
  0xf4,0x00,0xff,0x00,0x00,0xaa,0x00,0x00,
  0xff,0x00,0x00,0xff,0x00,0x03,0xff,0x00,
  0xbf,0xff,0x00,0xbc,0x0f,0x00,0x20,0x0f,
  0x00,0x00,0x3c,0x00,0x00,0x29,0x00,

  0x00,0xa8,0x00,0x00,0xa8,0x00,0x02,0xaa,
  0x00,0x00,0x5c,0x00,0x00,0x54,0x00,0x00,
  0x54,0x00,0x00,0x50,0x00,0x00,0xfc,0x00,
  0x00,0xab,0x00,0x00,0xff,0xf5,0x00,0xaa,
  0xf4,0x00,0xff,0x00,0x00,0xaa,0x00,0x00,
  0xff,0x00,0x00,0xff,0x00,0x02,0xff,0xf0,
  0x00,0xbf,0xf0,0x00,0x0f,0x00,0x00,0x3c,
  0x00,0x00,0xf0,0x00,0x02,0xa8,0x00,

  0x00,0xa8,0x00,0x00,0xa8,0x00,0x02,0xaa,
  0x00,0x00,0x5c,0x00,0x00,0x54,0x00,0x00,
  0x54,0x00,0x00,0x50,0x00,0x00,0xfc,0x00,
  0x00,0xab,0x00,0x00,0xff,0xf5,0x00,0xaa,
  0xf4,0x00,0xff,0x00,0x00,0xaa,0x00,0x00,
  0xff,0x00,0x00,0xff,0x00,0x00,0x3f,0xc0,
  0x00,0x3f,0xc0,0x00,0xf0,0xf0,0x00,0xf0,
  0xfe,0x00,0xf0,0x38,0x02,0xa8,0x20,

// Gilby 29-36

  0x00,0x00,0x00,0x00,0x28,0x00,0x00,0xaa,
  0x00,0x00,0x32,0x00,0x02,0x28,0x80,0x00,
  0xba,0x00,0x00,0xea,0x00,0x03,0xea,0x80,
  0x00,0xea,0x80,0x03,0xea,0x80,0x01,0xaa,
  0x40,0x04,0xaa,0x14,0x10,0x28,0x03,0xc0,
  0x00,0x01,0x40,0x00,0x01,0x40,0x00,0x01,
  0x40,0x00,0x01,0x40,0x00,0x01,0x40,0x00,
  0x01,0x40,0x00,0x01,0x40,0x00,0x00,

  0x00,0x28,0x00,0x00,0xaa,0x00,0x00,0x82,
  0x00,0x02,0x28,0x80,0x00,0xba,0x00,0x00,
  0xea,0x00,0x03,0xfa,0x80,0x03,0x3a,0x80,
  0x03,0xfa,0x80,0x00,0xaa,0x00,0x01,0xaa,
  0x57,0x01,0x28,0x01,0x04,0x00,0x04,0x04,
  0x00,0x10,0x30,0x00,0x40,0x10,0x01,0x00,
  0x10,0x00,0x00,0x10,0x00,0x00,0x10,0x00,
  0x00,0x10,0x00,0x00,0x10,0x00,0x00,

  0x00,0x28,0x00,0x00,0xaa,0x00,0x00,0x82,
  0x00,0x02,0x28,0x80,0x00,0xba,0x00,0x00,
  0xea,0x00,0x02,0xfe,0x80,0x02,0xce,0x80,
  0x02,0xfe,0x80,0x00,0xaa,0x00,0x01,0xaa,
  0x40,0x01,0x28,0x10,0x01,0x00,0x0c,0x01,
  0x00,0x10,0x0c,0x00,0x10,0x04,0x00,0x40,
  0x04,0x00,0x40,0x04,0x01,0x00,0x04,0x01,
  0x00,0x04,0x00,0x00,0x04,0x00,0x00,

  0x00,0x28,0x00,0x00,0xaa,0x00,0x00,0x82,
  0x00,0x02,0x28,0x80,0x00,0xba,0x00,0x00,
  0xea,0x00,0x02,0xbf,0x80,0x02,0xb3,0x80,
  0x02,0xbf,0x80,0x00,0xaa,0x00,0x01,0xaa,
  0x40,0x01,0x28,0x40,0x01,0x00,0x40,0x01,
  0x00,0x40,0x03,0x00,0xc0,0x01,0x00,0x40,
  0x01,0x00,0x40,0x01,0x00,0x40,0x01,0x00,
  0x40,0x01,0x00,0x40,0x01,0x00,0x40,

  0x00,0x28,0x00,0x00,0xaa,0x00,0x00,0x82,
  0x00,0x02,0x28,0x80,0x00,0xba,0x00,0x00,
  0xea,0x00,0x02,0xaf,0xc0,0x02,0xac,0xc0,
  0x02,0xaf,0xc0,0x00,0xaa,0x00,0x01,0xaa,
  0x40,0x04,0x26,0x40,0x30,0x00,0x40,0x04,
  0x00,0x40,0x04,0x00,0x30,0x01,0x00,0x10,
  0x01,0x00,0x10,0x00,0x40,0x10,0x00,0x40,
  0x10,0x00,0x00,0x10,0x00,0x00,0x10,

  0x00,0x28,0x00,0x00,0xaa,0x00,0x00,0x82,
  0x00,0x02,0x28,0x80,0x00,0xba,0x00,0x00,
  0xea,0x00,0x02,0xab,0xc0,0x02,0xab,0x00,
  0x02,0xab,0xc0,0x00,0xaa,0x00,0xd5,0xaa,
  0x40,0x40,0x28,0x40,0x10,0x00,0x10,0x04,
  0x00,0x10,0x01,0x00,0x0c,0x00,0x00,0x04,
  0x00,0x00,0x04,0x00,0x00,0x04,0x00,0x00,
  0x04,0x00,0x00,0x04,0x00,0x00,0x04,

  0x00,0x00,0x00,0x00,0x28,0x00,0x00,0xaa,
  0x00,0x00,0x82,0x00,0x02,0x28,0x80,0x00,
  0xba,0x00,0x00,0xea,0x00,0x02,0xaa,0x80,
  0x02,0xaa,0x80,0x02,0xaa,0x80,0x01,0xaa,
  0x40,0x14,0xaa,0x10,0xc0,0x28,0x04,0x40,
  0x00,0x03,0x40,0x00,0x01,0x40,0x00,0x01,
  0x40,0x00,0x01,0x40,0x00,0x01,0x40,0x00,
  0x01,0x40,0x00,0x01,0x00,0x00,0x01,

  0x00,0x00,0x00,0x00,0x28,0x00,0x00,0xaa,
  0x00,0x00,0x82,0x00,0x02,0x28,0x80,0x00,
  0xba,0x00,0x00,0xea,0x00,0x02,0xaa,0x80,
  0x02,0xaa,0x80,0x02,0xaa,0x80,0x01,0xaa,
  0x40,0x04,0xaa,0x10,0x10,0x28,0x04,0xc0,
  0x00,0x03,0x40,0x00,0x01,0x40,0x00,0x01,
  0x40,0x00,0x01,0x40,0x00,0x01,0x40,0x00,
  0x01,0x40,0x00,0x01,0x40,0x00,0x01,

// mama llama 37-41

  0x00,0x00,0xc0,0x00,0x01,0x80,0x00,0x01,
  0x60,0x00,0x01,0xf0,0x00,0x01,0xc0,0x00,
  0x01,0xe0,0x00,0x00,0xe0,0x00,0x00,0xf0,
  0x78,0x00,0x78,0xdf,0xff,0xf8,0x9f,0xff,
  0xf0,0x1f,0xff,0xf0,0x1f,0xff,0xe0,0x0f,
  0x9e,0xc0,0x0f,0x01,0xc0,0x07,0x8a,0xd0,
  0x01,0xc1,0x90,0x04,0x61,0x10,0x0c,0x23,
  0x18,0x08,0x22,0x08,0x0c,0x33,0x0c,

  0x00,0x00,0x60,0x00,0x00,0xc0,0x00,0x00,
  0xb0,0x00,0x00,0xf8,0x00,0x00,0xe0,0x00,
  0x00,0xf0,0x00,0x00,0x70,0x60,0x00,0x78,
  0xf8,0x00,0x78,0x9f,0xff,0xf8,0x9f,0xff,
  0xf0,0x1f,0xff,0xf0,0x1f,0xff,0xe0,0x0f,
  0xbc,0xc0,0x0f,0x01,0xc0,0x0f,0x01,0x90,
  0x07,0x83,0xb0,0x11,0xc3,0x30,0x18,0xc6,
  0x30,0x10,0x44,0x10,0x18,0x66,0x18,

  0x00,0x00,0x18,0x00,0x00,0x30,0x00,0x00,
  0x3c,0x00,0x00,0x3e,0x00,0x00,0x38,0x00,
  0x00,0x38,0x00,0x00,0x38,0x70,0x00,0x78,
  0xd8,0x00,0x78,0x9f,0xff,0xf8,0x1f,0xff,
  0xf0,0x1f,0xff,0xf0,0x1f,0xff,0xe0,0x0f,
  0xbc,0xe0,0x0f,0x00,0xe0,0x0f,0x00,0xc0,
  0x2e,0x01,0xc0,0x26,0x01,0x80,0x36,0x03,
  0x20,0x64,0x06,0x60,0x36,0x02,0x70,

  0x00,0x00,0x60,0x00,0x00,0xc0,0x00,0x00,
  0xb0,0x00,0x00,0xf8,0x00,0x00,0xe0,0x00,
  0x00,0xf0,0x00,0x00,0x70,0x70,0x00,0x78,
  0xd8,0x00,0x78,0x5f,0xff,0xf8,0x1f,0xff,
  0xf0,0x1f,0xff,0xf0,0x1f,0xff,0xe0,0x0f,
  0xbe,0xe0,0x0f,0x00,0xe0,0x0f,0x00,0x60,
  0x0e,0x00,0xe0,0x2c,0x00,0xc0,0x2c,0x01,
  0x80,0x08,0x01,0x00,0x0c,0x00,0x60,

  0x00,0x00,0xc0,0x00,0x01,0x80,0x00,0x01,
  0x60,0x00,0x01,0xf0,0x00,0x01,0xc0,0x00,
  0x01,0xe0,0x00,0x00,0xe0,0x70,0x00,0xf0,
  0xd8,0x00,0x78,0x9f,0xff,0xf8,0x1f,0xff,
  0xf0,0x1f,0xff,0xf0,0x1f,0xff,0xe0,0x0f,
  0xbe,0xe0,0x0f,0x00,0x70,0x0f,0x00,0x30,
  0x1c,0x00,0x30,0x1c,0x00,0xb0,0x18,0x00,
  0x90,0x12,0x00,0x98,0x18,0x00,0xc0,

// sheep in space sheep 42-44

  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x36,0x79,0x80,0x7b,0xbb,
  0xe0,0xf7,0xdd,0xf0,0xff,0xdd,0xe8,0xdf,
  0xbf,0xdc,0x5d,0xff,0xfc,0x0d,0xfb,0xff,
  0x03,0xf7,0x7b,0x04,0x41,0x9e,0x06,0xc1,
  0x9e,0x06,0x43,0xb6,0x07,0x63,0x32,

  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x36,0x79,0x80,0xfb,0xbb,
  0xe0,0xf7,0xdd,0xf0,0xff,0xdd,0xe8,0x5f,
  0xbf,0xdc,0x1d,0xff,0xfc,0x0d,0xfb,0xff,
  0x03,0xf7,0x7b,0x04,0x41,0x9e,0x06,0xc1,
  0x9e,0x06,0x43,0x9e,0x07,0x63,0x1a,

  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x36,0x79,0x80,0xfb,0xbb,
  0xe0,0xf7,0xdd,0xf0,0xdf,0xdd,0xe8,0x9f,
  0xbf,0xdc,0x1d,0xff,0xfc,0x0d,0xfb,0xff,
  0x03,0xf7,0x7f,0x04,0x41,0x9e,0x06,0xc1,
  0x9e,0x06,0x43,0x8e,0x07,0x63,0x00,

// SiS piman 45-48

  0x00,0x0e,0x00,0x00,0x3f,0x80,0x7c,0x6f,
  0xc0,0xff,0xff,0xc0,0x7c,0x77,0x80,0x80,
  0x2e,0x00,0x00,0x1c,0x00,0x00,0x3e,0x00,
  0x00,0x77,0x00,0x00,0x63,0x00,0x00,0x47,
  0x00,0x00,0x5f,0x00,0x00,0x7f,0x00,0x00,
  0x3e,0x00,0x00,0x7e,0x00,0x00,0xee,0x00,
  0x01,0xc7,0x00,0x03,0x87,0x00,0x03,0x87,
  0x00,0x03,0x83,0x80,0x0f,0x07,0x00,

  0x00,0x0e,0x00,0x7c,0x3f,0x80,0xfe,0x6f,
  0xc0,0x3f,0xff,0xc0,0x00,0x77,0x80,0x00,
  0x2e,0x00,0x00,0x1c,0x00,0x00,0x3e,0x00,
  0x00,0x77,0x00,0x00,0x63,0x00,0x00,0x67,
  0x00,0x00,0x67,0x00,0x00,0x7f,0x00,0x00,
  0x3e,0x00,0x00,0x7e,0x00,0x00,0x76,0x00,
  0x00,0x77,0x00,0x00,0xe3,0xe0,0x00,0xe1,
  0xe0,0x00,0xe0,0x60,0x03,0xe0,0x00,

  0x00,0x0e,0x00,0x00,0x3f,0x80,0x7c,0x6f,
  0xc0,0xff,0xff,0xc0,0x7c,0x77,0x80,0x00,
  0x2e,0x00,0x00,0x1c,0x00,0x00,0x3e,0x00,
  0x00,0x77,0x00,0x00,0x63,0x00,0x00,0x73,
  0x00,0x00,0x73,0x00,0x00,0x7f,0x00,0x00,
  0x3e,0x00,0x00,0x3e,0x00,0x00,0x7e,0x00,
  0x00,0xfc,0x00,0x00,0xfe,0x00,0x00,0x36,
  0x00,0x00,0x38,0x00,0x00,0xf8,0x00,
  
  0x00,0x0e,0x00,0x00,0x3f,0x80,0x00,0x6f,
  0xc0,0x7f,0xff,0xc0,0xff,0x77,0x80,0x7c,
  0x2e,0x00,0x00,0x1c,0x00,0x00,0x3e,0x00,
  0x00,0x77,0x00,0x00,0x63,0x00,0x00,0x63,
  0x00,0x00,0x47,0x00,0x00,0x7f,0x00,0x00,
  0x3e,0x00,0x00,0x3e,0x00,0x00,0x7e,0x00,
  0x00,0xfe,0x00,0x0d,0xee,0x00,0x0f,0x87,
  0x00,0x03,0x07,0x00,0x00,0x0f,0x00,

  // Donkeytron 49-51

  0x00,0x00,0x00,0x20,0x00,0x00,0x10,0x10,
  0x00,0x1b,0x20,0x00,0x3b,0xca,0x00,0x6b,
  0xf2,0x00,0x7b,0xfc,0xc0,0xf8,0xff,0x00,
  0x20,0x3f,0x8e,0x00,0x0f,0xfe,0x00,0x07,
  0xf3,0x00,0x03,0xf2,0x00,0x03,0xf5,0x00,
  0x07,0xf1,0x00,0x0f,0xe0,0x00,0x1b,0xc0,
  0x00,0x1f,0xc0,0x00,0x06,0xe0,0x00,0x06,
  0x00,0x00,0x0c,0x00,0x00,0x1c,0x00,

  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x20,0x00,0x00,0x40,0x00,0x01,
  0xcc,0x80,0x07,0xf9,0x00,0x97,0xfe,0x60,
  0x7b,0xff,0x86,0x2c,0x1f,0xff,0x3c,0x07,
  0xf3,0x38,0x03,0xf3,0x30,0x07,0xf3,0x00,
  0x1f,0xf5,0x00,0x7f,0xe2,0x00,0x38,0xc2,
  0x00,0x0e,0xc4,0x00,0x07,0xc0,0x00,0x01,
  0x80,0x00,0x01,0x80,0x00,0x03,0x80,

  0x00,0x00,0x00,0x08,0x00,0x00,0x04,0x00,
  0x00,0x0d,0x48,0x00,0x15,0xd0,0x00,0x3d,
  0xf3,0x00,0x7d,0xfc,0x00,0x4c,0xff,0x60,
  0x10,0x3f,0x8e,0x00,0x0f,0xfa,0x00,0x07,
  0xf2,0x00,0x07,0xf3,0x00,0x0f,0xf3,0x00,
  0x1f,0xf5,0x00,0x3c,0x71,0x00,0x30,0xe0,
  0x00,0x60,0x38,0x00,0x60,0x18,0x00,0xe0,
  0x18,0x00,0x00,0x18,0x00,0x00,0x38,

// Grumpy bunny out of SiS 52-55

  0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x00,
  0x30,0x0f,0x80,0xf8,0x0d,0x81,0xb8,0x00,
  0xc3,0x10,0x00,0xc3,0x00,0x00,0x7e,0x00,
  0x01,0xfe,0x00,0x07,0x33,0x80,0x0f,0xff,
  0xc0,0x0f,0xff,0xc0,0x0f,0x87,0xc0,0x0f,
  0x7b,0xc0,0x07,0xff,0x80,0x01,0xfe,0x00,
  0x00,0x78,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,

  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,
  0x00,0x78,0x7b,0x80,0xde,0x31,0x81,0x8e,
  0x00,0xc3,0x04,0x00,0x7e,0x00,0x01,0xfe,
  0x00,0x07,0x33,0x80,0x0e,0xfd,0xc0,0x0f,
  0xff,0xc0,0x0f,0x87,0xc0,0x0f,0x03,0xc0,
  0x07,0xff,0x80,0x01,0xfe,0x00,0x00,0x78,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,

  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x1c,0x00,0x00,
  0x7f,0x00,0xf8,0x79,0x81,0x9e,0x30,0xc7,
  0x0e,0x00,0x7e,0x00,0x01,0xfe,0x00,0x07,
  0x33,0x80,0x0e,0x31,0xc0,0x0f,0xff,0xc0,
  0x0f,0x87,0xc0,0x0f,0x03,0xc0,0x0e,0x79,
  0xc0,0x07,0xff,0x80,0x01,0xfe,0x00,

  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x00,
  0xfc,0x00,0x00,0xe7,0x81,0xfc,0x00,0xc7,
  0x1e,0x00,0x7e,0x0c,0x01,0xfe,0x00,0x07,
  0xff,0x80,0x0e,0x31,0xc0,0x1f,0xff,0xe0,
  0x3f,0xff,0xf0,0x3f,0xff,0xf0,0x7e,0x66,
  0x78,0xf9,0x99,0x9c,0x3f,0xff,0xf0,


};

const uint8_t sig[]=
{
 
// this is my name sprite from out of ROTMC title page
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x86,0x07,0x00,0x00,0x00,0x00,0x00,  0x00,0x03,0x3b,
0x0d,0x83,0x30,0x00,0x06,0x00,0x00,0x03,0x63,0x0f,0x03,0x30,0x00,0x06,0x60,0x00,0x03,0x3b,0x1c,0x07,0xf8,0x00,0x3f,0xc0,
0x00,0x01,0x86,
0x36,0x06,0xd8,0x00,0x66,0x00,0x00,0x00,0xfc,0x06,0x06,0xd8,0x60,0x06,0x00,0x67,0x00,0x00, 0x06,0x06,0xd8,0x60,0x06,0x38,0x6d,0x80,0x00,0x06,0x06,0x18,0x06,0xc6,0x6c,0x78,0xc0,0x00,0x03,0x06,0x18,0xc7,0x66,0xc6,
0x60,0x00,0x00,
0x03,0x06,0x0c,0xc6,0x66,0xc6,0x60,0x00,0x00,0x03,0x0c,0x0c,0xc6,0x66,0x6c,0x60,0x00,0x00,0x03,0x0c,0x0c,0xc6,0x66,0x38,
0x60,0x00,0x00,
0x66,0x0c,0x0f,0xec,0x6f,0x6c,0x60,0x00,0x00,0x3c,0x6c,0x06,0x38,0x39,0xc7,0xc0,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7f,0x80,0x00,0x00,0x00,0x00,0x3f,0xff,0xff,
0xc0,0x00,0x00,
0x0f,0xff,0xff,0xe0,0x00,0x00,0x00,0x00,0x00,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

};

// this is the struct for the second pips
struct secondPip
{
  uint8_t x;
  uint8_t y;
};

struct secondPip *pips[NUM_SECOND_PIPS];  // Holds the precalculated positions of the second-pips

// some state for changing the animation

uint8_t lastMinute=64;
uint8_t lastHour=64;
uint8_t currentAnimation=0;
const uint8_t maxAnimation=11;

// the palette for the Gordon Bennett sprite

const int gbPalette[4]={0x000000,0xc18178,0xd5df7c,0x867ade}; 

// palette for Iridis Alpha Gilby

const int iaPalette[4]={0x000000,0xc18178,0x8a46ae,0xffffff};

// stuff describing the animations themselves

const uint8_t minFrames[12]={52,49,45,42,37,29,24,20,16,0,8,4};
const uint8_t maxFrames[12]={55,51,48,44,41,36,28,23,19,3,15,7};
const uint8_t animFlags[12]={1,0,0,1,0,0,0,1,0,0,0,1};
const int animCols[12]={0xc151a9,0x79c1c8,0xc37b75,0xffffff,0xc18178,0,0,0xffb000,0xff7f00,0xffffff,0xff8000,0xffffff};
const int *animPals[12]={NULL,NULL,NULL,NULL,NULL,iaPalette,gbPalette,NULL,NULL,NULL,NULL,NULL};



// need to be able to see the time so..
struct tm *t;  // Structure holding easily read components of the time.
time_t temp;	 // Raw epoch time.

static void applog(const char* message)
{
	app_log(APP_LOG_LEVEL_INFO, "renderer.c", 0, message);
}

// let's work towards a much more general pixMap renderer

static void drawPixMap(struct pixMap *pm,GContext* ctx)
{

// if b&w watch set default white
#ifndef PBL_COLOR
  graphics_context_set_fill_color(ctx, GColorWhite);
#else
  graphics_context_set_fill_color(ctx,GColorFromHEX(pm->col));
#endif
  const int *pal=pm->pal;
  int pindex,i;
  uint8_t *map=(uint8_t *)pm->raw;
  uint16_t szx=pm->width*pm->dotPitchX;
  uint16_t szy=pm->height*pm->dotPitchY;
  uint16_t bytesPerLine=pm->width>>3;
  uint16_t base=bytesPerLine*pm->height*pm->index;
  uint16_t oy=pm->y-(pm->dotHeight>>1)-(szy>>1);
  for(int j=0;j<pm->height;j++)
  {
    uint16_t ox=pm->x-(pm->dotWidth>>1)-(szx>>1);
    if(pm->plpal) // per line palette
    {
#ifdef PBL_COLOR
      graphics_context_set_fill_color(ctx,GColorFromHEX(pm->plpal[j]));
#endif
    }
    for(int k=0;k<bytesPerLine;k++)
    {
      uint8_t ccline=map[base];
      if(pal)  // non-NULL pal means multiple bits per pixel
      {
        // byte unpacking loop for 2 bits per pixel
        uint16_t ox2=ox+pm->dotPitchX*6;
        for(i=0;i<4;i++)
        {
          pindex=ccline&3;
          ccline>>=2;
#ifndef PBL_COLOR
          pindex+=2; // I have to touch pindex here for the applite build or the compiler barfs
#else
          graphics_context_set_fill_color(ctx,GColorFromHEX((int)pal[pindex]));
#endif
          graphics_fill_rect(ctx, GRect(ox2>>8,oy>>8,pm->dotWidth>>7,pm->dotHeight>>8),0,GCornerNone);
          ox2-=pm->dotPitchX<<1;
        }
        ox+=pm->dotPitchX<<3;
      }
      else // byte unpacking loop for 1 bit per pixel
      {
        for(i=0;i<8;i++)
        {
           if((1<<(7-i))&ccline)
             graphics_fill_rect(ctx, GRect(ox>>8,oy>>8,pm->dotWidth>>8,pm->dotHeight>>8),0,GCornerNone);
          ox+=pm->dotPitchX;
        }
      }
      base++;
    }
    oy+=pm->dotPitchY;
  }
}

// something to animate the pixMap

static void animatePixMap(struct pixMap *pm)
{
  if(pm->animFlags&1) // this flag will be for bounce animation
  {
    pm->index+=pm->frameStep;
    if(pm->index<pm->minFrame||pm->index>pm->maxFrame)
    {
      pm->frameStep*=-1;
      pm->index+=pm->frameStep*2;
    }
  }
  else // just normal loop animation
  {
    pm->index++;
    if(pm->index>pm->maxFrame) pm->index=pm->minFrame;
  }
}

static void hourChanged()
{
  // this will be called every time the hour changes
  // use it to change any state per hour on the hour

  c64sprite->minFrame=minFrames[currentAnimation];
  c64sprite->maxFrame=maxFrames[currentAnimation];
  c64sprite->index=minFrames[currentAnimation];
  c64sprite->frameStep=1;
  c64sprite->animFlags=animFlags[currentAnimation];
  c64sprite->col=animCols[currentAnimation];
  c64sprite->pal=animPals[currentAnimation];
  // set am or pm digit palette om each time digit
  for(int i=0;i<4;i++)
     timeDigits[i]->plpal=(t->tm_hour>11)?digitpal_pm:digitpal_am;
}

// make stuff needed during run time

static void makeCrap()
{
  uint16_t pipAng=0;
  uint16_t pipAngInc=0x10000/NUM_SECOND_PIPS;
  int i;

// fetch the time so I can set everything up right at first run

  temp = time(NULL);	   // get raw time
  t = localtime(&temp);  // break it up into readable bits
  currentAnimation=t->tm_hour%12;

// precalculate the positions of the second pips

  for(i=0;i<NUM_SECOND_PIPS;i++)
  {
    pips[i]=malloc(sizeof(struct secondPip));
    pips[i]->x=((sin_lookup(pipAng)*(PIPS_RADIUS<<8)/TRIG_MAX_RATIO)>>8)+72;
    pips[i]->y=((-cos_lookup(pipAng)*(PIPS_RADIUS<<8)/TRIG_MAX_RATIO)>>8)+81;
    pipAng+=pipAngInc;
  }

// make and initialise 4 pixmap structures for the time digits

  const uint16_t dotPitchX=3<<8;	// Step per glyph X pixel
  const uint16_t dotWidth=3<<8;	// Actual size of X pixel
  for(i=0;i<4;i++)
  {
    timeDigits[i]=malloc(sizeof(struct pixMap));
    // set defaults common to all
    timeDigits[i]->width=8;
    timeDigits[i]->height=8;
    timeDigits[i]->index=i;
    timeDigits[i]->raw=(void *)amcdigits;
    timeDigits[i]->dotPitchX=dotPitchX;
    timeDigits[i]->dotPitchY=4<<8;
    timeDigits[i]->dotWidth=dotWidth;
    timeDigits[i]->dotHeight=4<<8;
    timeDigits[i]->y=(CENTREY+21)<<8;
    timeDigits[i]->col=0xffff00;
    timeDigits[i]->pal=NULL;
    timeDigits[i]->plpal=(t->tm_hour>11)?digitpal_pm:digitpal_am;
  }

// calculate the x-positions correctly

  const uint16_t glyphSeparation=2<<8;	// space between glyphs
  const uint16_t digitPairSeparation=10<<8;	// space between the 2 digit pairs
  uint16_t gx=((CENTREX+2)<<8)-12*dotPitchX-glyphSeparation-(digitPairSeparation>>1);
  timeDigits[0]->x=gx;
  gx+=8*dotPitchX+glyphSeparation;
  timeDigits[1]->x=gx;
  gx+=8*dotPitchX+digitPairSeparation;
  timeDigits[2]->x=gx;
  gx+=8*dotPitchX+glyphSeparation;
  timeDigits[3]->x=gx;

// now set up a pixmap to animate a sprite in
// a standard c64 sprite is 24x21 in size

  c64sprite=malloc(sizeof(struct pixMap));
  c64sprite->width=24;
  c64sprite->height=21;
  c64sprite->raw=(void *)sprites;
  c64sprite->dotPitchX=3<<8;
  c64sprite->dotPitchY=3<<8;
  c64sprite->dotWidth=3<<8;
  c64sprite->dotHeight=2<<8;
  c64sprite->x=CENTREX<<8;
  c64sprite->y=(CENTREY-30)<<8;
  c64sprite->plpal=0;
// call the changed hour routine
// to initialise the first animation

  currentAnimation=0;
  hourChanged();  

// make my "sig"

  jm=malloc(sizeof(struct pixMap));
  jm->width=72;
  jm->height=21;
  jm->raw=(void *)sig;
  jm->dotPitchX=1<<8;
  jm->dotPitchY=1<<8;
  jm->dotWidth=1<<8;
  jm->dotHeight=1<<8;
  jm->x=(CENTREX+8)<<8;
  jm->y=(CENTREY+48)<<8;
  jm->index=0;
  jm->col=0xc000ff;
  jm->pal=NULL;
  jm->plpal=NULL;


}

// throw away the pips and pixmaps when done with them

static void destroyCrap()
{
  int i;
  for(i=0;i<NUM_SECOND_PIPS;i++) free(pips[i]);   
  for(i=0;i<4;i++) free(timeDigits[i]);   
  free(c64sprite);    
  free(jm);      
}
                

	
/****************************** Renderer Lifecycle *****************************/



/*
 * Render 
 */
static void timer_callback(void *data)
{	
  //Render
  layer_mark_dirty(canvas);
  timer=app_timer_register(delta,(AppTimerCallback) timer_callback,0);
}

/*
 * Start rendering loop
 */
static void start()
{
  timer=app_timer_register(delta,(AppTimerCallback) timer_callback,0);
}



/*
 * Rendering
 */
static void render(Layer *layer, GContext* ctx) 
{
  int i;

  // Get the current bits of the time

  temp = time(NULL);	   // get raw time
  t = localtime(&temp);  // break it up into readable bits
  uint16_t currentSecond=t->tm_sec;  // the current second
  uint16_t currentMinute=t->tm_min;
  uint16_t currentHour=t->tm_hour;
  if(currentHour>11) currentHour-=12;
  currentAnimation=currentHour;
  if(currentHour==0) currentHour=12;

// Upon first run copy the current hour and sec ro last hour and sec

  if(lastMinute>60)  // will never naturally occur, set that way at first run
  {
    lastMinute=currentMinute;
    lastHour=currentHour;
  }
  else // in normal runs we can check for changed min or hour and do something
  {
    if(currentHour!=lastHour)
    {
      lastHour=currentHour;
      hourChanged();
    }
  }
  if(currentSecond>59) currentSecond=59;  // Can happen, apparently, if there is a leap second. 
  
  //Setup (set white fill once and for all if watch is not colour)

#ifndef PBL_COLOR
  graphics_context_set_fill_color(ctx, GColorWhite);
#endif

  // if watch is colour set the pip colour

#ifdef PBL_COLOR
  graphics_context_set_fill_color(ctx,GColorFromRGB(40,255,0));     
#endif

  // draw the pips

  for(i=0;i<currentSecond;i++)
    {
     graphics_fill_rect(ctx,GRect(pips[i]->x-2,pips[i]->y-2,4,4), 0, GCornerNone);
    }

  // if it's the last pip draw a larger pip

#ifdef PBL_COLOR
  graphics_context_set_fill_color(ctx,GColorFromRGB(255,0,255));     
#endif
  graphics_fill_rect(ctx,GRect(pips[currentSecond]->x-3,pips[currentSecond]->y-3,6,6), 0, GCornerNone);

  // draw time digits

  timeDigits[0]->index=currentHour/10;
  timeDigits[1]->index=currentHour%10;
  timeDigits[2]->index=t->tm_min/10;
  timeDigits[3]->index=t->tm_min%10;
  for(i=0;i<4;i++) 
    drawPixMap(timeDigits[i],ctx);
  

  // draw a pulsing semicolon

  if(currentSecond&1)
  {
#ifndef PBL_COLOR
  graphics_context_set_fill_color(ctx, GColorWhite);
#endif
#ifdef PBL_COLOR
  graphics_context_set_fill_color(ctx,GColorFromRGB(255,255,0));     
#endif
  }
  else // on alternate seconds erase instead of draw the semicolon
  {
    graphics_context_set_fill_color(ctx, GColorBlack);
  }
  graphics_fill_rect(ctx,GRect(CENTREX-5+2,CENTREY-12+26,4,6), 0, GCornerNone);
  graphics_fill_rect(ctx,GRect(CENTREX-5+2,CENTREY+2+26,4,6), 0, GCornerNone);  
 
  // draw a c64 sprite and my sig

  drawPixMap(c64sprite,ctx);
  drawPixMap(jm,ctx);
  // update animation ready for next frame

  animatePixMap(c64sprite);
 
}

/****************************** Window Lifecycle *****************************/


static void window_load(Window *window)
{
	//Setup window
	window_set_background_color(window, GColorBlack);
	
	//Setup canvas
	canvas = layer_create(GRect(0, 0, 144, 168));
	layer_set_update_proc(canvas, (LayerUpdateProc) render);
	layer_add_child(window_get_root_layer(window), canvas);
	
	//Start rendering
	start();
}

static void window_unload(Window *window) 
{
	//Cancel timer
	app_timer_cancel(timer);

	//Destroy canvas
	layer_destroy(canvas);
}

/****************************** App Lifecycle *****************************/


static void init(void) {
	window = window_create();
	window_set_window_handlers(window, (WindowHandlers) 
	{
		.load = window_load,
		.unload = window_unload,
	});
	
	//Prepare everything
	makeCrap();
	//Finally
	window_stack_push(window, true);
}

static void deinit(void) 
{
	//De-init everything
	destroyCrap();
	//Finally
	window_destroy(window);
}

int main(void) 
{
	init();
	app_event_loop();
	deinit();
}
